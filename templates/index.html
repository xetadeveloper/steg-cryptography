{% extends "base.html" %}

{% block title %}Cryptographic Steganography - Secure Message Hiding{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-3">
                <i data-feather="shield" class="me-3"></i>
                Cryptographic Steganography
            </h1>
            <p class="lead text-muted">
                Hide encrypted messages in images using AES-256, RSA, HMAC-SHA256, and LSB steganography
            </p>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <!-- Key Generation Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="key" class="me-2"></i>
                        RSA Key Generation
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Generate RSA key pairs for testing the encryption pipeline.</p>
                    <button id="generateKeysBtn" class="btn btn-secondary">
                        <i data-feather="refresh-cw" class="me-2"></i>
                        Generate RSA Key Pair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="encrypt-tab" data-bs-toggle="tab" data-bs-target="#encrypt" type="button" role="tab">
                        <i data-feather="lock" class="me-2"></i>
                        Encrypt Message
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="decrypt-tab" data-bs-toggle="tab" data-bs-target="#decrypt" type="button" role="tab">
                        <i data-feather="unlock" class="me-2"></i>
                        Decrypt Message
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- Encryption Tab -->
                <div class="tab-pane fade show active" id="encrypt" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="edit-3" class="me-2"></i>
                                Encrypt and Hide Message
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="encryptForm" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="encryptMessage" class="form-label">Message to Encrypt</label>
                                            <textarea class="form-control" id="encryptMessage" name="message" rows="4" 
                                                    placeholder="Enter your secret message here..." required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="encryptImage" class="form-label">Cover Image</label>
                                            <input type="file" class="form-control" id="encryptImage" name="image" 
                                                   accept="image/*" required>
                                            <div class="form-text">Select an image to hide your message in</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="encryptPublicKey" class="form-label">RSA Public Key (Optional)</label>
                                            <textarea class="form-control" id="encryptPublicKey" name="rsa_public_key" rows="6" 
                                                    placeholder="-----BEGIN PUBLIC KEY-----&#10;...&#10;-----END PUBLIC KEY-----"></textarea>
                                            <div class="form-text">Leave empty to generate new key pair</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="encryptHmacKey" class="form-label">HMAC Key</label>
                                            <input type="text" class="form-control" id="encryptHmacKey" name="hmac_key" 
                                                   value="default_hmac_key" placeholder="Enter HMAC key">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-feather="lock" class="me-2"></i>
                                        Encrypt and Hide Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Encryption Results -->
                    <div id="encryptResults" class="card mt-4" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="check-circle" class="me-2"></i>
                                Encryption Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Steganographic Image</label>
                                        <div class="border rounded p-3 text-center">
                                            <img id="stegoImage" class="img-fluid" style="max-height: 300px;" alt="Steganographic Image">
                                            <div class="mt-2">
                                                <button id="downloadStegoBtn" class="btn btn-sm btn-outline-secondary">
                                                    <i data-feather="download" class="me-1"></i>
                                                    Download Image
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">RSA Private Key (Keep Safe!)</label>
                                        <textarea id="resultPrivateKey" class="form-control" rows="8" readonly></textarea>
                                        <button id="copyPrivateKeyBtn" class="btn btn-sm btn-outline-secondary mt-2">
                                            <i data-feather="copy" class="me-1"></i>
                                            Copy Private Key
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Encrypted AES Key</label>
                                        <textarea id="resultEncryptedAES" class="form-control" rows="3" readonly></textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">HMAC Signature</label>
                                        <textarea id="resultHMAC" class="form-control" rows="3" readonly></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Decryption Tab -->
                <div class="tab-pane fade" id="decrypt" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="eye" class="me-2"></i>
                                Decrypt Hidden Message
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="decryptForm" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="decryptImage" class="form-label">Steganographic Image</label>
                                            <input type="file" class="form-control" id="decryptImage" name="stego_image" 
                                                   accept="image/*" required>
                                            <div class="form-text">Select the image containing the hidden message</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="decryptPrivateKey" class="form-label">RSA Private Key</label>
                                            <textarea class="form-control" id="decryptPrivateKey" name="rsa_private_key" rows="8" 
                                                    placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" required></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="decryptEncryptedAES" class="form-label">Encrypted AES Key</label>
                                            <textarea class="form-control" id="decryptEncryptedAES" name="encrypted_aes_key" rows="3" 
                                                    placeholder="Base64 encoded encrypted AES key" required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="decryptHMAC" class="form-label">HMAC Signature</label>
                                            <textarea class="form-control" id="decryptHMAC" name="hmac_signature" rows="3" 
                                                    placeholder="Base64 encoded HMAC signature" required></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="decryptHmacKey" class="form-label">HMAC Key</label>
                                            <input type="text" class="form-control" id="decryptHmacKey" name="hmac_key" 
                                                   value="default_hmac_key" placeholder="Enter HMAC key" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">
                                        <i data-feather="unlock" class="me-2"></i>
                                        Decrypt Hidden Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Decryption Results -->
                    <div id="decryptResults" class="card mt-4" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i data-feather="message-square" class="me-2"></i>
                                Decrypted Message
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Original Message</label>
                                <textarea id="decryptedMessage" class="form-control" rows="4" readonly></textarea>
                            </div>
                            
                            <div class="alert alert-info d-flex align-items-center">
                                <i data-feather="info" class="me-2"></i>
                                <div>
                                    <strong>HMAC Verification:</strong> 
                                    <span id="hmacStatus" class="badge bg-success">Verified</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How It Works Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="info" class="me-2"></i>
                        How It Works
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <i data-feather="edit-3" class="text-white"></i>
                            </div>
                            <h6 class="mt-2">1. AES Encryption</h6>
                            <small class="text-muted">Message encrypted with AES-256-CBC</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="bg-info rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <i data-feather="key" class="text-white"></i>
                            </div>
                            <h6 class="mt-2">2. RSA Key Exchange</h6>
                            <small class="text-muted">AES key encrypted with RSA-2048-OAEP</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <i data-feather="shield" class="text-white"></i>
                            </div>
                            <h6 class="mt-2">3. HMAC Signing</h6>
                            <small class="text-muted">Integrity protection with HMAC-SHA256</small>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                <i data-feather="image" class="text-white"></i>
                            </div>
                            <h6 class="mt-2">4. Steganography</h6>
                            <small class="text-muted">Hidden in image using LSB technique</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate RSA Keys
    document.getElementById('generateKeysBtn').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/generate_keys', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('encryptPublicKey').value = data.public_key;
                document.getElementById('decryptPrivateKey').value = data.private_key;
                showAlert('RSA key pair generated successfully!', 'success');
            } else {
                showAlert('Error generating keys: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'danger');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    // Encryption Form
    document.getElementById('encryptForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Encrypting...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/encrypt', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayEncryptionResults(data);
                showAlert('Message encrypted and hidden successfully!', 'success');
            } else {
                showAlert('Encryption failed: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'danger');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Decryption Form
    document.getElementById('decryptForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Decrypting...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/decrypt', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayDecryptionResults(data);
                showAlert('Message decrypted successfully!', 'success');
            } else {
                showAlert('Decryption failed: ' + data.error, 'danger');
            }
        } catch (error) {
            showAlert('Network error: ' + error.message, 'danger');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Copy to clipboard functionality
    document.getElementById('copyPrivateKeyBtn').addEventListener('click', function() {
        const privateKey = document.getElementById('resultPrivateKey');
        privateKey.select();
        document.execCommand('copy');
        showAlert('Private key copied to clipboard!', 'info');
    });

    // Download steganographic image
    let stegoImageData = null;
    document.getElementById('downloadStegoBtn').addEventListener('click', function() {
        if (stegoImageData) {
            const link = document.createElement('a');
            link.href = 'data:image/png;base64,' + stegoImageData;
            link.download = 'steganographic_image.png';
            link.click();
        }
    });

    function displayEncryptionResults(data) {
        document.getElementById('stegoImage').src = 'data:image/png;base64,' + data.stego_image;
        document.getElementById('resultPrivateKey').value = data.rsa_private_key || 'Not available (public key was provided)';
        document.getElementById('resultEncryptedAES').value = data.encrypted_aes_key;
        document.getElementById('resultHMAC').value = data.hmac_signature;
        
        // Auto-fill decryption form
        if (data.rsa_private_key) {
            document.getElementById('decryptPrivateKey').value = data.rsa_private_key;
        }
        document.getElementById('decryptEncryptedAES').value = data.encrypted_aes_key;
        document.getElementById('decryptHMAC').value = data.hmac_signature;
        
        // Store image data for download
        stegoImageData = data.stego_image;
        
        document.getElementById('encryptResults').style.display = 'block';
        document.getElementById('encryptResults').scrollIntoView({ behavior: 'smooth' });
        
        // Re-initialize feather icons
        feather.replace();
    }

    function displayDecryptionResults(data) {
        document.getElementById('decryptedMessage').value = data.decrypted_message;
        
        const hmacStatus = document.getElementById('hmacStatus');
        if (data.hmac_verified) {
            hmacStatus.textContent = 'Verified ✓';
            hmacStatus.className = 'badge bg-success';
        } else {
            hmacStatus.textContent = 'Failed ✗';
            hmacStatus.className = 'badge bg-danger';
        }
        
        document.getElementById('decryptResults').style.display = 'block';
        document.getElementById('decryptResults').scrollIntoView({ behavior: 'smooth' });
    }

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
        
        // Scroll to alert
        alertDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize feather icons
    feather.replace();
});
</script>
{% endblock %}
